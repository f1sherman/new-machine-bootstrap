---
- name: Clone tmux plugin manager (tpm)
  git:
    repo: 'https://github.com/tmux-plugins/tpm'
    dest: '{{ ansible_facts["user_dir"] }}/.tmux/plugins/tpm'
    depth: 1
    version: master
    update: yes

- name: Copy tmux configuration for Codespaces
  copy:
    src: '{{ playbook_dir }}/roles/codespaces/files/dotfiles/tmux.conf'
    dest: '{{ ansible_facts["user_dir"] }}/.tmux.conf'
    mode: 0644
    backup: yes

- name: Create ~/.byobu directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.byobu'
    state: directory
    mode: 0755

- name: Copy tmux configuration for byobu
  copy:
    src: '{{ playbook_dir }}/roles/codespaces/files/dotfiles/tmux.conf'
    dest: '{{ ansible_facts["user_dir"] }}/.byobu/.tmux.conf'
    mode: 0644
    backup: yes

- name: Install tmux plugins via tpm
  shell: |
    export TMUX_PLUGIN_MANAGER_PATH="{{ ansible_facts["user_dir"] }}/.tmux/plugins/"
    bash "{{ ansible_facts["user_dir"] }}/.tmux/plugins/tpm/bin/install_plugins"
  args:
    creates: '{{ ansible_facts["user_dir"] }}/.tmux/plugins/tmux-resurrect'

- name: Check if fzf shell directory exists
  stat:
    path: '{{ ansible_facts["user_dir"] }}/.fzf/shell'
  register: fzf_shell_dir

- name: Create full FZF integration (when shell dir exists)
  copy:
    content: |
      # Setup fzf
      # ---------
      if [[ ! "$PATH" == *${HOME}/.fzf/bin* ]]; then
        PATH="${PATH:+${PATH}:}${HOME}/.fzf/bin"
      fi

      # Auto-completion
      [[ $- == *i* ]] && source "${HOME}/.fzf/shell/completion.zsh" 2> /dev/null

      # Key bindings
      source "${HOME}/.fzf/shell/key-bindings.zsh"
    dest: '{{ ansible_facts["user_dir"] }}/.fzf.zsh'
    mode: 0644
  when: fzf_shell_dir.stat.exists

- name: Create minimal FZF integration (when shell dir doesn't exist)
  copy:
    content: |
      # Setup fzf
      # ---------
      # Debian package version doesn't support --zsh flag
      # Basic PATH setup only
      if [[ ! "$PATH" == */usr/bin* ]]; then
        PATH="${PATH:+${PATH}:}/usr/bin"
      fi
    dest: '{{ ansible_facts["user_dir"] }}/.fzf.zsh'
    mode: 0644
  when: not fzf_shell_dir.stat.exists

- name: Set default shell to zsh
  user:
    name: '{{ ansible_facts["user_id"] }}'
    shell: /usr/bin/zsh
  become: yes

- name: Configure byobu auto-launch in .zprofile
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zprofile'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BYOBU"
    block: |
      # Launch byobu on SSH login
      # Attach to detached session if available, otherwise create new session
      if [ -z "$TMUX" ] && [ -n "$SSH_CONNECTION" ]; then
        if byobu list-sessions 2>/dev/null | grep -v '(attached)' | grep -q .; then
          exec byobu attach
        else
          exec byobu new-session
        fi
      fi

- name: Configure byobu auto-launch in .bashrc
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.bashrc'
    create: no
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BYOBU"
    block: |
      # Launch byobu with zsh on SSH login
      # Attach to detached session if available, otherwise create new session
      if [ -z "$TMUX" ] && [ -n "$SSH_CONNECTION" ]; then
        export SHELL=/usr/bin/zsh
        if byobu list-sessions 2>/dev/null | grep -v '(attached)' | grep -q .; then
          exec byobu attach /usr/bin/zsh -l
        else
          exec byobu new-session /usr/bin/zsh -l
        fi
      fi
    insertafter: BOF

- name: Remove mise from .bashrc
  lineinfile:
    path: '{{ ansible_facts["user_dir"] }}/.bashrc'
    regexp: '.*mise.*'
    state: absent

- name: Remove byobu auto-launch from .zshrc.local
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BYOBU"
    block: ""
    state: absent

- name: Configure Codespaces prompt customization
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PROMPT"
    block: |
      # Codespaces prompt customization - use pure theme with git info
      if [[ -n "$CODESPACES" ]]; then
        prompt pure
      fi

- name: Enable true color support in Codespaces
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - COLORTERM"
    block: |
      # Enable true color support for terminal applications
      export COLORTERM=truecolor

- name: Add claude alias to avoid API key conflict
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - CLAUDE ALIAS"
    block: |
      # Unset ANTHROPIC_API_KEY when running claude to avoid conflict with OAuth token
      alias claude='unset ANTHROPIC_API_KEY; claude'

- name: Ensure pipx path is configured
  command: pipx ensurepath
  changed_when: false
  failed_when: false

- name: Configure Claude Code settings in .claude.json
  shell: |
    python3 -c '
    import json
    import glob
    import os

    config_file = os.environ["CONFIG_FILE"]

    # Read existing config or create new one
    if os.path.exists(config_file):
      with open(config_file, "r") as f:
        data = json.load(f)
    else:
      data = {}

    changed = False

    # Set hasCompletedOnboarding
    if not data.get("hasCompletedOnboarding"):
      data["hasCompletedOnboarding"] = True
      changed = True

    # Ensure projects section exists
    if "projects" not in data:
      data["projects"] = {}
      changed = True

    # Auto-trust all existing workspace directories and enable all MCP servers
    for workspace_dir in glob.glob("/workspaces/*"):
      if workspace_dir not in data["projects"]:
        data["projects"][workspace_dir] = {
          "hasTrustDialogAccepted": True,
          "enableAllProjectMcpServers": True,
          "allowedTools": [],
          "mcpContextUris": [],
          "mcpServers": {},
          "enabledMcpjsonServers": [],
          "disabledMcpjsonServers": []
        }
        changed = True
      else:
        if not data["projects"][workspace_dir].get("hasTrustDialogAccepted"):
          data["projects"][workspace_dir]["hasTrustDialogAccepted"] = True
          changed = True
        if not data["projects"][workspace_dir].get("enableAllProjectMcpServers"):
          data["projects"][workspace_dir]["enableAllProjectMcpServers"] = True
          changed = True

    if changed:
      with open(config_file, "w") as f:
        json.dump(data, f, indent=2)
      os.chmod(config_file, 0o600)
      print("changed")
    else:
      print("unchanged")
    '
  environment:
    CONFIG_FILE: '{{ ansible_facts["user_dir"] }}/.claude.json'
  register: claude_config_result
  changed_when: "'changed' in claude_config_result.stdout"

