---

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install Codespaces packages
  apt:
    name:
      - bat
      - byobu
      - curl
      - fd-find
      - git
      - neovim
      - python3
      - python3-pip
      - python3-venv
      - pipx
      - ripgrep
      - sudo
      - tmux
      - unzip
      - zsh
    state: present
  become: yes

- name: Create ~/.local/bin directory
  file:
    path: '{{ ansible_env.HOME }}/.local/bin'
    state: directory
    mode: 0755

- name: Remove fzf apt package if installed
  apt:
    name: fzf
    state: absent
  become: yes

- name: Check if fzf already exists in .local/bin
  stat:
    path: '{{ ansible_env.HOME }}/.local/bin/fzf'
  register: fzf_binary

- name: Get latest fzf release version
  uri:
    url: https://api.github.com/repos/junegunn/fzf/releases/latest
    return_content: yes
  register: fzf_latest_release
  retries: 3
  delay: 10
  until: fzf_latest_release is succeeded
  when: not fzf_binary.stat.exists

- name: Set fzf version without v prefix
  set_fact:
    fzf_version: "{{ fzf_latest_release.json.tag_name | regex_replace('^v', '') }}"
  when: not fzf_binary.stat.exists

- name: Download and extract fzf binary
  unarchive:
    src: "https://github.com/junegunn/fzf/releases/download/{{ fzf_latest_release.json.tag_name }}/fzf-{{ fzf_version }}-linux_amd64.tar.gz"
    dest: '{{ ansible_env.HOME }}/.local/bin'
    remote_src: yes
  retries: 3
  delay: 10
  when: not fzf_binary.stat.exists

- name: Clone fzf repo for shell integration files
  git:
    repo: 'https://github.com/junegunn/fzf.git'
    dest: '{{ ansible_env.HOME }}/.fzf'
    depth: 1
    version: master
    update: yes

- name: Create fd symlink (fdfind -> fd)
  file:
    src: /usr/bin/fdfind
    dest: '{{ ansible_env.HOME }}/.local/bin/fd'
    state: link

- name: Create bat symlink (batcat -> bat)
  file:
    src: /usr/bin/batcat
    dest: '{{ ansible_env.HOME }}/.local/bin/bat'
    state: link

- name: Create vim symlink (nvim -> vim)
  file:
    src: /usr/bin/nvim
    dest: '{{ ansible_env.HOME }}/.local/bin/vim'
    state: link

- name: Copy tmux configuration for Codespaces
  copy:
    src: '{{ playbook_dir }}/roles/codespaces/files/dotfiles/tmux.conf'
    dest: '{{ ansible_env.HOME }}/.tmux.conf'
    mode: 0644
    backup: yes

- name: Create ~/.byobu directory
  file:
    path: '{{ ansible_env.HOME }}/.byobu'
    state: directory
    mode: 0755

- name: Copy tmux configuration for byobu
  copy:
    src: '{{ playbook_dir }}/roles/codespaces/files/dotfiles/tmux.conf'
    dest: '{{ ansible_env.HOME }}/.byobu/.tmux.conf'
    mode: 0644
    backup: yes

- name: Check if fzf shell directory exists
  stat:
    path: '{{ ansible_env.HOME }}/.fzf/shell'
  register: fzf_shell_dir

- name: Create full FZF integration (when shell dir exists)
  copy:
    content: |
      # Setup fzf
      # ---------
      if [[ ! "$PATH" == *${HOME}/.fzf/bin* ]]; then
        PATH="${PATH:+${PATH}:}${HOME}/.fzf/bin"
      fi

      # Auto-completion
      [[ $- == *i* ]] && source "${HOME}/.fzf/shell/completion.zsh" 2> /dev/null

      # Key bindings
      source "${HOME}/.fzf/shell/key-bindings.zsh"
    dest: '{{ ansible_env.HOME }}/.fzf.zsh'
    mode: 0644
  when: fzf_shell_dir.stat.exists

- name: Create minimal FZF integration (when shell dir doesn't exist)
  copy:
    content: |
      # Setup fzf
      # ---------
      # Debian package version doesn't support --zsh flag
      # Basic PATH setup only
      if [[ ! "$PATH" == */usr/bin* ]]; then
        PATH="${PATH:+${PATH}:}/usr/bin"
      fi
    dest: '{{ ansible_env.HOME }}/.fzf.zsh'
    mode: 0644
  when: not fzf_shell_dir.stat.exists

- name: Set default shell to zsh
  user:
    name: '{{ ansible_user_id }}'
    shell: /usr/bin/zsh
  become: yes

- name: Configure byobu auto-launch in .zprofile
  blockinfile:
    path: '{{ ansible_env.HOME }}/.zprofile'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BYOBU"
    block: |
      # Launch byobu on SSH login
      if [ -z "$TMUX" ] && [ -n "$SSH_CONNECTION" ]; then
        exec byobu new-session -A -s main
      fi

- name: Configure byobu auto-launch in .bashrc
  blockinfile:
    path: '{{ ansible_env.HOME }}/.bashrc'
    create: no
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BYOBU"
    block: |
      # Launch byobu with zsh on SSH login, exit SSH when detached
      if [ -z "$TMUX" ] && [ -n "$SSH_CONNECTION" ]; then
        export SHELL=/usr/bin/zsh
        exec byobu new-session -A -s main /usr/bin/zsh -l
      fi
    insertafter: BOF

- name: Remove mise from .bashrc
  lineinfile:
    path: '{{ ansible_env.HOME }}/.bashrc'
    regexp: '.*mise.*'
    state: absent

- name: Remove byobu auto-launch from .zshrc.local
  blockinfile:
    path: '{{ ansible_env.HOME }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BYOBU"
    block: ""
    state: absent

- name: Configure Codespaces prompt customization
  blockinfile:
    path: '{{ ansible_env.HOME }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PROMPT"
    block: |
      # Codespaces prompt customization - use pure theme with git info
      if [[ -n "$CODESPACES" ]]; then
        prompt pure
      fi

- name: Ensure pipx path is configured
  command: pipx ensurepath
  changed_when: false
  failed_when: false

- name: Auto-trust Codespaces workspaces and skip onboarding in .claude.json
  shell: |
    python3 -c '
    import json
    import glob
    from datetime import datetime

    try:
      with open("{{ ansible_env.HOME }}/.claude.json", "r") as f:
        data = json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
      data = {}

    if "projects" not in data:
      data["projects"] = {}

    changed = False

    # Auto-trust all existing workspace directories and enable all MCP servers
    for workspace_dir in glob.glob("/workspaces/*"):
      if workspace_dir not in data["projects"]:
        data["projects"][workspace_dir] = {
          "hasTrustDialogAccepted": True,
          "enableAllProjectMcpServers": True,
          "allowedTools": [],
          "mcpContextUris": [],
          "mcpServers": {},
          "enabledMcpjsonServers": [],
          "disabledMcpjsonServers": []
        }
        changed = True
      else:
        if not data["projects"][workspace_dir].get("hasTrustDialogAccepted"):
          data["projects"][workspace_dir]["hasTrustDialogAccepted"] = True
          changed = True
        if not data["projects"][workspace_dir].get("enableAllProjectMcpServers"):
          data["projects"][workspace_dir]["enableAllProjectMcpServers"] = True
          changed = True

    # Skip onboarding prompts
    if not data.get("hasCompletedOnboarding"):
      data["hasCompletedOnboarding"] = True
      data["lastOnboardingVersion"] = "2.0.0"
      data["firstStartTime"] = datetime.utcnow().isoformat() + "Z"
      changed = True

    if changed:
      with open("{{ ansible_env.HOME }}/.claude.json", "w") as f:
        json.dump(data, f, indent=2)
      print("changed")
    else:
      print("unchanged")
    '
  register: claude_trust_result
  changed_when: "'changed' in claude_trust_result.stdout"
  when: ansible_env.CODESPACES is defined
