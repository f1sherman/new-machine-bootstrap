---
- name: Clone tmux plugin manager (tpm)
  git:
    repo: 'https://github.com/tmux-plugins/tpm'
    dest: '{{ ansible_facts["user_dir"] }}/.tmux/plugins/tpm'
    depth: 1
    version: master
    update: yes

- name: Copy tmux configuration for Codespaces
  copy:
    src: '{{ playbook_dir }}/roles/codespaces/files/dotfiles/tmux.conf'
    dest: '{{ ansible_facts["user_dir"] }}/.tmux.conf'
    mode: 0644
    backup: yes

- name: Install tmux plugins via tpm
  shell: |
    export TMUX_PLUGIN_MANAGER_PATH="{{ ansible_facts["user_dir"] }}/.tmux/plugins/"
    "{{ ansible_facts["user_dir"] }}/.tmux/plugins/tpm/bin/install_plugins"
  args:
    creates: '{{ ansible_facts["user_dir"] }}/.tmux/plugins/tmux-resurrect'

- name: Check if fzf shell directory exists
  stat:
    path: '{{ ansible_facts["user_dir"] }}/.fzf/shell'
  register: fzf_shell_dir

- name: Create full FZF integration (when shell dir exists)
  copy:
    content: |
      # Setup fzf
      # ---------
      if [[ ! "$PATH" == *${HOME}/.fzf/bin* ]]; then
        PATH="${PATH:+${PATH}:}${HOME}/.fzf/bin"
      fi

      # Auto-completion
      [[ $- == *i* ]] && source "${HOME}/.fzf/shell/completion.zsh" 2> /dev/null

      # Key bindings
      source "${HOME}/.fzf/shell/key-bindings.zsh"
    dest: '{{ ansible_facts["user_dir"] }}/.fzf.zsh'
    mode: 0644
  when: fzf_shell_dir.stat.exists

- name: Create minimal FZF integration (when shell dir doesn't exist)
  copy:
    content: |
      # Setup fzf
      # ---------
      # Debian package version doesn't support --zsh flag
      # Basic PATH setup only
      if [[ ! "$PATH" == */usr/bin* ]]; then
        PATH="${PATH:+${PATH}:}/usr/bin"
      fi
    dest: '{{ ansible_facts["user_dir"] }}/.fzf.zsh'
    mode: 0644
  when: not fzf_shell_dir.stat.exists

- name: Set default shell to zsh
  user:
    name: '{{ ansible_facts["user_id"] }}'
    shell: /usr/bin/zsh
  become: yes

- name: Configure tmux auto-launch in .zprofile
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zprofile'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - TMUX"
    block: |
      # Launch tmux on SSH login
      # Attach to detached session if available, otherwise create new session
      if [ -z "$TMUX" ] && [ -n "$SSH_CONNECTION" ]; then
        if tmux list-sessions 2>/dev/null | grep -v '(attached)' | grep -q .; then
          exec tmux attach
        else
          exec tmux new-session
        fi
      fi

- name: Configure zsh exec in .bashrc
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.bashrc'
    create: no
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - ZSH"
    block: |
      # Switch to zsh on SSH login (zsh will then launch tmux via .zprofile)
      if [ -z "$TMUX" ] && [ -n "$SSH_CONNECTION" ]; then
        exec /usr/bin/zsh -l
      fi
    insertafter: BOF

- name: Remove mise from .bashrc
  lineinfile:
    path: '{{ ansible_facts["user_dir"] }}/.bashrc'
    regexp: '.*mise.*'
    state: absent

- name: Remove tmux auto-launch from .zshrc.local
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - TMUX"
    block: ""
    state: absent

- name: Configure Codespaces prompt customization
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PROMPT"
    block: |
      # Codespaces prompt customization - use pure theme with git info
      if [[ -n "$CODESPACES" ]]; then
        prompt pure
      fi

- name: Enable true color support in Codespaces
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - COLORTERM"
    block: |
      # Enable true color support for terminal applications
      export COLORTERM=truecolor

- name: Add claude alias to avoid API key conflict
  blockinfile:
    path: '{{ ansible_facts["user_dir"] }}/.zshrc.local'
    create: yes
    mode: 0644
    marker: "# {mark} ANSIBLE MANAGED BLOCK - CLAUDE ALIAS"
    block: |
      # Unset ANTHROPIC_API_KEY only for claude command to avoid conflict with OAuth token
      alias claude='ANTHROPIC_API_KEY= command claude'

- name: Ensure pipx path is configured
  command: pipx ensurepath
  changed_when: false
  failed_when: false

- name: Create pre-commit hook from environment variable
  copy:
    content: "{{ lookup('env', 'PRE_COMMIT_HOOK') }}"
    dest: '/workspaces/{{ lookup("env", "RepositoryName") }}/.git/hooks/pre-commit'
    mode: '0755'
  when: lookup('env', 'PRE_COMMIT_HOOK') | length > 0

- name: Configure Claude Code settings in .claude.json
  shell: |
    python3 -c '
    import json
    import glob
    import os

    config_file = os.environ["CONFIG_FILE"]

    # Read existing config or create new one
    if os.path.exists(config_file):
      with open(config_file, "r") as f:
        data = json.load(f)
    else:
      data = {}

    changed = False

    # Set hasCompletedOnboarding
    if not data.get("hasCompletedOnboarding"):
      data["hasCompletedOnboarding"] = True
      changed = True

    if data.get("editorMode") != "vim":
      data["editorMode"] = "vim"
      changed = True

    # Ensure projects section exists
    if "projects" not in data:
      data["projects"] = {}
      changed = True

    default_allowed_tools = [
      "Write(.coding-agent/plans/**)",
      "Write(.coding-agent/research/**)",
      "Write(.coding-agent/handoffs/**)",
      "Bash(mkdir -p:*)",
      "Bash(~/bin/claude/spec-metadata:*)"
    ]

    # Auto-trust all existing workspace directories and disable MCP servers
    for workspace_dir in glob.glob("/workspaces/*"):
      if workspace_dir not in data["projects"]:
        data["projects"][workspace_dir] = {
          "hasTrustDialogAccepted": True,
          "enableAllProjectMcpServers": False,
          "allowedTools": default_allowed_tools.copy(),
          "mcpContextUris": [],
          "mcpServers": {},
          "enabledMcpjsonServers": [],
          "disabledMcpjsonServers": []
        }
        changed = True
      else:
        if not data["projects"][workspace_dir].get("hasTrustDialogAccepted"):
          data["projects"][workspace_dir]["hasTrustDialogAccepted"] = True
          changed = True
        if data["projects"][workspace_dir].get("enableAllProjectMcpServers"):
          data["projects"][workspace_dir]["enableAllProjectMcpServers"] = False
          changed = True
        existing_tools = data["projects"][workspace_dir].get("allowedTools", [])
        for tool in default_allowed_tools:
          if tool not in existing_tools:
            existing_tools.append(tool)
            changed = True
        data["projects"][workspace_dir]["allowedTools"] = existing_tools

    if changed:
      with open(config_file, "w") as f:
        json.dump(data, f, indent=2)
      os.chmod(config_file, 0o600)
      print("changed")
    else:
      print("unchanged")
    '
  environment:
    CONFIG_FILE: '{{ ansible_facts["user_dir"] }}/.claude.json'
  register: claude_config_result
  changed_when: "'changed' in claude_config_result.stdout"

- name: Ensure ~/.claude directory exists
  file:
    path: '{{ ansible_facts["user_dir"] }}/.claude'
    state: directory
    mode: 0755

- name: Configure Claude Code user settings in ~/.claude/settings.json
  shell: |
    python3 -c '
    import json
    import os

    settings_file = os.environ["SETTINGS_FILE"]

    # Read existing settings or create new one
    if os.path.exists(settings_file):
      with open(settings_file, "r") as f:
        data = json.load(f)
    else:
      data = {}

    changed = False

    # Ensure permissions section exists
    if "permissions" not in data:
      data["permissions"] = {}
      changed = True

    # Ensure allow list exists
    if "allow" not in data["permissions"]:
      data["permissions"]["allow"] = []
      changed = True

    # Add /tmp permissions if not present
    tmp_permissions = ["Read(//tmp/**)", "Edit(//tmp/**)", "Write(//tmp/**)"]
    for perm in tmp_permissions:
      if perm not in data["permissions"]["allow"]:
        data["permissions"]["allow"].append(perm)
        changed = True

    if changed:
      with open(settings_file, "w") as f:
        json.dump(data, f, indent=2)
      os.chmod(settings_file, 0o600)
      print("changed")
    else:
      print("unchanged")
    '
  environment:
    SETTINGS_FILE: '{{ ansible_facts["user_dir"] }}/.claude/settings.json'
  register: claude_settings_result
  changed_when: "'changed' in claude_settings_result.stdout"

