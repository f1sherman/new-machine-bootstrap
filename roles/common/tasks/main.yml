---
# Common Role - Shared Configuration
#
# DEPENDENCIES (must be installed via pre_tasks):
# - git: for repository cloning
# - nvim: for plugin installation
# - fzf: for vim plugin 'do' hooks
# - rg (ripgrep): referenced in dotfiles
# - tmux, bat: used by scripts
# - python3 or grealpath: used by pick-files
#
# This role assumes all tools are available from platform packages.

- name: Create .ssh directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.ssh'
    state: directory
    mode: 0700

- name: Add GitHub to known_hosts
  known_hosts:
    name: github.com
    key: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
    path: '{{ ansible_facts["user_dir"] }}/.ssh/known_hosts'
    state: present

- name: Clone prezto
  git:
    dest: '{{ ansible_facts["user_dir"] }}/.zprezto'
    repo: 'https://github.com/sorin-ionescu/prezto.git'
    recursive: yes
    update: yes

- name: Clone vim config repository
  git:
    dest: '{{ ansible_facts["user_dir"] }}/.vim'
    repo: "{{ 'https://github.com/f1sherman/dotvim.git' if lookup('env', 'CODESPACES') == 'true' else 'git@github.com:f1sherman/dotvim.git' }}"
    update: yes
    force: no

- name: Create nvim autoload directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.local/share/nvim/site/autoload'
    state: directory
    mode: 0755

- name: Download vim-plug for neovim
  get_url:
    url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    dest: '{{ ansible_facts["user_dir"] }}/.local/share/nvim/site/autoload/plug.vim'
    mode: 0644

- name: Create ~/.config/nvim directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.config/nvim'
    state: directory
    mode: 0755

- name: Check if dotvim vimrc exists
  stat:
    path: '{{ ansible_facts["user_dir"] }}/.vim/vimrc'
  register: dotvim_vimrc

- name: Link vimrc to ~/.vimrc
  file:
    src: '{{ ansible_facts["user_dir"] }}/.vim/vimrc'
    dest: '{{ ansible_facts["user_dir"] }}/.vimrc'
    state: link
  when: dotvim_vimrc.stat.exists

- name: Link vimrc to neovim init.vim
  file:
    src: '{{ ansible_facts["user_dir"] }}/.vim/vimrc'
    dest: '{{ ansible_facts["user_dir"] }}/.config/nvim/init.vim'
    state: link
  when: dotvim_vimrc.stat.exists

- name: Create nvim sessions directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.local/share/nvim/sessions'
    state: directory
    mode: 0755

- name: Initialize nvim and install/update plugins
  command: '{{ item }}'
  changed_when: false
  with_items:
    - nvim +qall
    - nvim +PlugInstall +qall
    - nvim +PlugUpdate +qall
    - nvim +PlugUpgrade +qall
    - nvim +PlugClean! +qall

- name: Create dotfile subdirectories
  file:
    path: '{{ ansible_facts["user_dir"] }}/.{{ item.path }}'
    state: directory
    mode: 0700
  with_filetree: '{{ playbook_dir }}/roles/common/templates/dotfiles/'
  when: item.state == 'directory'

- name: Install shared dotfiles
  template:
    backup: no
    dest: '{{ ansible_facts["user_dir"] }}/.{{ item.path }}'
    src: '{{ item.src }}'
    mode: 0600
  with_filetree: '{{ playbook_dir }}/roles/common/templates/dotfiles/'
  # Exclude macOS AppleDouble metadata files (._*) that store extended attributes
  when: item.state == 'file' and not item.path.startswith('._')

- name: Remove AppleDouble files from .claude directory
  command: find {{ ansible_facts["user_dir"] }}/.claude -name '._*' -delete
  changed_when: false

- name: Create ~/bin directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/bin'
    state: directory

- name: Install pick-files script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/pick-files'
    src: '{{ playbook_dir }}/roles/common/files/bin/pick-files'
    mode: 0755

- name: Install osc52-copy script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/osc52-copy'
    src: '{{ playbook_dir }}/roles/common/files/bin/osc52-copy'
    mode: 0755

- name: Install git-diff-untracked script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/git-diff-untracked'
    src: '{{ playbook_dir }}/roles/common/files/bin/git-diff-untracked'
    mode: 0755

- name: Install spec-metadata script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/spec-metadata'
    src: '{{ playbook_dir }}/roles/common/files/bin/spec-metadata'
    mode: 0755

- name: Install list-codex-sessions script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/list-codex-sessions'
    src: '{{ playbook_dir }}/roles/common/files/bin/list-codex-sessions'
    mode: 0755

- name: Install list-claude-sessions script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/list-claude-sessions'
    src: '{{ playbook_dir }}/roles/common/files/bin/list-claude-sessions'
    mode: 0755

- name: Install read-codex-session script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/read-codex-session'
    src: '{{ playbook_dir }}/roles/common/files/bin/read-codex-session'
    mode: 0755

- name: Install read-claude-session script
  copy:
    backup: yes
    dest: '{{ ansible_facts["user_dir"] }}/bin/read-claude-session'
    src: '{{ playbook_dir }}/roles/common/files/bin/read-claude-session'
    mode: 0755

- name: Create ~/.claude directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.claude'
    state: directory
    mode: '0700'

- name: Create ~/.claude/CLAUDE.md file
  copy:
    content: |
      ## Bias Toward Action

      When you can do something yourself, do it instead of asking me to do it. This includes:
      - Running provisioning/deployment commands after making changes
      - Validating changes by running tests or checks
      - Checking current state before and after changes
      - SSH-ing into a host and running a command
      - Clicking through a webflow

      Only ask me to do something if it requires physical interaction, access you don't have, or is genuinely ambiguous.

      ## Code Comments

      Add code comments sparingly. Focus on why something is done, especially for complex logic, rather than what is done. Only add high-value comments if necessary for clarity or if requested by the user. Do not edit comments that are separate from the code you are changing. NEVER talk to the user or describe your changes through comments.

      ## GitHub API Rate Limits (gh CLI)

      GitHub enforces rate limits: 5,000 requests/hour primary, plus secondary limits (100 concurrent requests, 900 points/minute). Multiple parallel Claude sessions share these limits.

      **Guidelines:**
      - **Prefer local git over API** - use `git log`, `git diff`, `git status` instead of `gh` when the information is available locally
      - **Reasonable polling intervals** - when waiting on CI or PR status, poll no more frequently than every 30 seconds
      - **If rate limited** - stop making requests, run `gh api rate_limit` to check reset time, and inform the user

      ## Commits and Pull Requests

      Never create git commits or pull requests without explicit user request.
    dest: '{{ ansible_facts["user_dir"] }}/.claude/CLAUDE.md'
    mode: '0600'
    backup: yes

- name: Create ~/.codex directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.codex'
    state: directory
    mode: '0700'

- name: Create ~/.codex/AGENTS.md symlink to ~/.claude/CLAUDE.md
  file:
    src: '{{ ansible_facts["user_dir"] }}/.claude/CLAUDE.md'
    dest: '{{ ansible_facts["user_dir"] }}/.codex/AGENTS.md'
    state: link

- name: Create ~/.config/amp directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.config/amp'
    state: directory
    mode: '0700'

- name: Create ~/.config/amp/AGENTS.md symlink to ~/.claude/CLAUDE.md
  file:
    src: '{{ ansible_facts["user_dir"] }}/.claude/CLAUDE.md'
    dest: '{{ ansible_facts["user_dir"] }}/.config/amp/AGENTS.md'
    state: link

- name: Create ccstatusline config directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.config/ccstatusline'
    state: directory
    mode: '0700'

- name: Install ccstatusline widget configuration
  copy:
    src: '{{ playbook_dir }}/roles/common/files/config/ccstatusline/settings.json'
    dest: '{{ ansible_facts["user_dir"] }}/.config/ccstatusline/settings.json'
    mode: '0600'

- name: Configure Claude Code vim mode in ~/.claude.json
  shell: |
    python3 -c '
    import json
    import os

    config_file = os.path.expanduser("~/.claude.json")

    # Read existing config or create new one
    if os.path.exists(config_file):
      with open(config_file, "r") as f:
        data = json.load(f)
    else:
      data = {}

    changed = False

    if data.get("editorMode") != "vim":
      data["editorMode"] = "vim"
      changed = True

    if changed:
      with open(config_file, "w") as f:
        json.dump(data, f, indent=2)
      os.chmod(config_file, 0o600)
      print("changed")
    else:
      print("unchanged")
    '
  register: claude_vim_mode_result
  changed_when: "'changed' in claude_vim_mode_result.stdout"

- name: Check if Claude Code CLI is installed
  command: command -v claude
  register: claude_cli_check
  changed_when: false
  failed_when: false

- name: Install Claude Code CLI
  shell: curl -fsSL https://claude.ai/install.sh | bash
  args:
    creates: '{{ ansible_facts["user_dir"] }}/.local/bin/claude'
  when: claude_cli_check.rc != 0

- name: Check if Claude settings.json exists
  stat:
    path: '{{ ansible_facts["user_dir"] }}/.claude/settings.json'
  register: claude_settings_stat

- name: Read existing Claude settings.json if it exists
  slurp:
    src: '{{ ansible_facts["user_dir"] }}/.claude/settings.json'
  register: claude_settings_content
  when: claude_settings_stat.stat.exists

- name: Parse existing Claude settings or use empty object
  set_fact:
    claude_settings: "{{ (claude_settings_content.content | b64decode | from_json) if claude_settings_stat.stat.exists else {} }}"

- name: Set ccstatusline version
  set_fact:
    ccstatusline_version: "2.0.21"

- name: Merge model and ccstatusline into Claude settings
  set_fact:
    merged_settings: "{{ claude_settings | combine({'model': 'opus', 'statusLine': {'type': 'command', 'command': 'npx -y ccstatusline@' ~ ccstatusline_version, 'padding': 0}}, recursive=True) }}"

- name: Write merged Claude settings.json
  copy:
    content: "{{ merged_settings | to_nice_json }}"
    dest: '{{ ansible_facts["user_dir"] }}/.claude/settings.json'
    mode: '0600'
    backup: yes

- name: Trust mise config in Codespaces
  command: mise trust {{ playbook_dir }}/mise.toml
  changed_when: false
  when: lookup('env', 'CODESPACES') == 'true'

- name: Check if Codex CLI is installed
  command: command -v codex
  register: codex_cli_check
  changed_when: false
  failed_when: false

- name: Install Codex CLI via npm (macOS)
  npm:
    name: '@openai/codex'
    global: yes
    state: present
  when: ansible_facts["os_family"] == "Darwin" and codex_cli_check.rc != 0

# Codespaces: Use mise's npm explicitly since Ansible sees the system nvm node
- name: Install Codex CLI via npm (Codespaces)
  shell: |
    eval "$(mise activate bash)"
    npm install -g @openai/codex
  args:
    executable: /bin/bash
  when: lookup('env', 'CODESPACES') == 'true' and codex_cli_check.rc != 0

# Codex CLI configuration for automatic API key authentication

# macOS: Determine if this is a personal or work machine
- name: Check bootstrap config (macOS)
  stat:
    path: '{{ ansible_facts["user_dir"] }}/.config/new-machine-bootstrap.yml'
  register: bootstrap_config_stat
  when: ansible_facts["os_family"] == "Darwin"

- name: Read bootstrap config (macOS)
  slurp:
    src: '{{ ansible_facts["user_dir"] }}/.config/new-machine-bootstrap.yml'
  register: bootstrap_config_content
  when: ansible_facts["os_family"] == "Darwin" and bootstrap_config_stat.stat.exists

- name: Set bootstrap use (macOS)
  set_fact:
    bootstrap_use: "{{ (bootstrap_config_content.content | b64decode | from_yaml).use | default('work') }}"
  when: ansible_facts["os_family"] == "Darwin" and bootstrap_config_stat.stat.exists

- name: Default bootstrap use (macOS)
  set_fact:
    bootstrap_use: 'work'
  when: ansible_facts["os_family"] == "Darwin" and not bootstrap_config_stat.stat.exists

# macOS: Read API key from file
- name: Check if OpenAI API key file exists (macOS)
  stat:
    path: '{{ ansible_facts["user_dir"] }}/.config/api-keys/openai'
  register: openai_api_key_stat
  when: ansible_facts["os_family"] == "Darwin" and bootstrap_use == 'work'

- name: Read OpenAI API key from file (macOS)
  slurp:
    src: '{{ ansible_facts["user_dir"] }}/.config/api-keys/openai'
  register: openai_api_key_content
  when: ansible_facts["os_family"] == "Darwin" and bootstrap_use == 'work' and openai_api_key_stat.stat.exists and openai_api_key_stat.stat.size > 0

- name: Configure Codex CLI auth.json (macOS)
  copy:
    content: |
      {
        "OPENAI_API_KEY": "{{ openai_api_key_content.content | b64decode | trim }}"
      }
    dest: '{{ ansible_facts["user_dir"] }}/.codex/auth.json'
    mode: '0600'
  when: ansible_facts["os_family"] == "Darwin" and bootstrap_use == 'work' and openai_api_key_stat.stat.exists and openai_api_key_stat.stat.size > 0

# Codespaces: Read API key from environment variable
- name: Configure Codex CLI auth.json (Codespaces)
  copy:
    content: |
      {
        "OPENAI_API_KEY": "{{ lookup('env', 'OPENAI_API_KEY') }}"
      }
    dest: '{{ ansible_facts["user_dir"] }}/.codex/auth.json'
    mode: '0600'
  when: lookup('env', 'CODESPACES') == 'true' and lookup('env', 'OPENAI_API_KEY') != ''

# Trust settings for Codespaces
- name: Configure Codex CLI config.toml for Codespaces
  shell: |
    python3 -c '
    import os
    import glob

    config_file = os.environ["CONFIG_FILE"]

    existing_projects = set()
    if os.path.exists(config_file):
      with open(config_file, "r") as f:
        for line in f:
          if line.startswith("[projects."):
            start = line.find("\"")
            end = line.rfind("\"")
            if start != -1 and end != -1 and start < end:
              existing_projects.add(line[start+1:end])

    changed = False
    new_sections = []

    for workspace_dir in glob.glob("/workspaces/*"):
      if os.path.isdir(workspace_dir) and workspace_dir not in existing_projects:
        new_sections.append(f"\n[projects.\"{workspace_dir}\"]\n")
        new_sections.append("trust_level = \"trusted\"\n")
        changed = True

    if changed:
      with open(config_file, "a") as f:
        f.writelines(new_sections)
      os.chmod(config_file, 0o600)
      print("changed")
    else:
      print("unchanged")
    '
  environment:
    CONFIG_FILE: '{{ ansible_facts["user_dir"] }}/.codex/config.toml'
  register: codex_config_result
  changed_when: "'changed' in codex_config_result.stdout"
  when: lookup('env', 'CODESPACES') == 'true'

# Trust settings for macOS
- name: Configure Codex CLI config.toml for macOS projects
  shell: |
    python3 -c '
    import os
    import glob

    config_file = os.environ["CONFIG_FILE"]
    projects_dir = os.path.expanduser("~/projects")

    existing_projects = set()
    if os.path.exists(config_file):
      with open(config_file, "r") as f:
        for line in f:
          if line.startswith("[projects."):
            start = line.find("\"")
            end = line.rfind("\"")
            if start != -1 and end != -1 and start < end:
              existing_projects.add(line[start+1:end])

    changed = False
    new_sections = []

    if os.path.isdir(projects_dir):
      for project_dir in glob.glob(os.path.join(projects_dir, "*")):
        if os.path.isdir(project_dir) and project_dir not in existing_projects:
          new_sections.append(f"\n[projects.\"{project_dir}\"]\n")
          new_sections.append("trust_level = \"trusted\"\n")
          changed = True

    if changed:
      with open(config_file, "a") as f:
        f.writelines(new_sections)
      os.chmod(config_file, 0o600)
      print("changed")
    else:
      print("unchanged")
    '
  environment:
    CONFIG_FILE: '{{ ansible_facts["user_dir"] }}/.codex/config.toml'
  register: codex_config_macos_result
  changed_when: "'changed' in codex_config_macos_result.stdout"
  when: ansible_facts["os_family"] == "Darwin"

# Skills installation (shared across Claude Code, Codex, and Amp)
- name: Create ~/.claude/skills directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.claude/skills'
    state: directory
    mode: '0755'

- name: Create ~/.codex/skills directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.codex/skills'
    state: directory
    mode: '0755'

- name: Create ~/.config/agents/skills directory
  file:
    path: '{{ ansible_facts["user_dir"] }}/.config/agents/skills'
    state: directory
    mode: '0755'

- name: Install Claude-specific skills to ~/.claude/skills
  copy:
    src: '{{ playbook_dir }}/roles/common/files/config/skills/claude/'
    dest: '{{ ansible_facts["user_dir"] }}/.claude/skills/'
    mode: preserve
    directory_mode: '0755'

- name: Install common skills to ~/.claude/skills
  copy:
    src: '{{ playbook_dir }}/roles/common/files/config/skills/common/'
    dest: '{{ ansible_facts["user_dir"] }}/.claude/skills/'
    mode: preserve
    directory_mode: '0755'

- name: Install Codex-specific skills to ~/.codex/skills
  copy:
    src: '{{ playbook_dir }}/roles/common/files/config/skills/codex/'
    dest: '{{ ansible_facts["user_dir"] }}/.codex/skills/'
    mode: preserve
    directory_mode: '0755'

- name: Install common skills to ~/.codex/skills
  copy:
    src: '{{ playbook_dir }}/roles/common/files/config/skills/common/'
    dest: '{{ ansible_facts["user_dir"] }}/.codex/skills/'
    mode: preserve
    directory_mode: '0755'

- name: Create Amp skills symlinks to Claude skills
  file:
    src: '{{ ansible_facts["user_dir"] }}/.claude/skills/{{ item | basename }}'
    dest: '{{ ansible_facts["user_dir"] }}/.config/agents/skills/{{ item | basename }}'
    state: link
  with_fileglob:
    - '{{ playbook_dir }}/roles/common/files/config/skills/claude/*'
    - '{{ playbook_dir }}/roles/common/files/config/skills/common/*'

- name: Remove deprecated Claude slash command files
  file:
    path: '{{ ansible_facts["user_dir"] }}/.claude/commands/{{ item }}'
    state: absent
  with_items:
    - 'personal:commit.md'
    - 'personal:create-handoff.md'
    - 'personal:create-plan.md'
    - 'personal:implement-plan.md'
    - 'personal:research-codebase.md'
    - 'personal:resume-handoff.md'
    - 'personal:validate-plan.md'
    - 'personal-commit.md'
    - 'personal-create-handoff.md'
    - 'personal-create-plan.md'
    - 'personal-implement-plan.md'
    - 'personal-research-codebase.md'
    - 'personal-resume-handoff.md'
    - 'personal-validate-plan.md'

- name: Remove deprecated Codex slash command files
  file:
    path: '{{ ansible_facts["user_dir"] }}/.codex/commands/{{ item }}'
    state: absent
  with_items:
    - 'personal:commit.md'
    - 'personal:create-handoff.md'
    - 'personal:create-plan.md'
    - 'personal:implement-plan.md'
    - 'personal:research-codebase.md'
    - 'personal:resume-handoff.md'
    - 'personal:validate-plan.md'
    - 'personal-commit.md'
    - 'personal-create-handoff.md'
    - 'personal-create-plan.md'
    - 'personal-implement-plan.md'
    - 'personal-research-codebase.md'
    - 'personal-resume-handoff.md'
    - 'personal-validate-plan.md'

# Work provisioning for Codespaces
- name: Create ~/projects directory for work provisioning
  file:
    path: '{{ ansible_facts["user_dir"] }}/projects'
    state: directory
    mode: '0755'
  when: lookup('env', 'CODESPACES') == 'true'

- name: Clone or update work provisioning repository
  shell: |
    if [ -d '{{ ansible_facts["user_dir"] }}/projects/bootstrap-brian-john' ]; then
      cd '{{ ansible_facts["user_dir"] }}/projects/bootstrap-brian-john'
      git -c credential.helper='!gh auth git-credential' pull --autostash
    else
      gh repo clone betterup/bootstrap-brian-john '{{ ansible_facts["user_dir"] }}/projects/bootstrap-brian-john'
    fi
  environment:
    GH_TOKEN: "{{ ansible_env.GH_TOKEN | default('') }}"
  when: lookup('env', 'CODESPACES') == 'true'

- name: Run work provisioning
  command: '{{ ansible_facts["user_dir"] }}/projects/bootstrap-brian-john/bin/provision'
  changed_when: false
  when: lookup('env', 'CODESPACES') == 'true'
