#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<'EOF'
Usage: worktree-done [--main <branch>]

Merges the current worktree branch into the main branch and deletes the worktree.
EOF
}

if ! command -v git >/dev/null 2>&1; then
  echo "Error: git is required" >&2
  exit 1
fi

main_branch=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --main)
      main_branch="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      echo "Error: unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      echo "Error: unexpected argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if ! repo_root=$(git rev-parse --show-toplevel 2>/dev/null); then
  echo "Error: not inside a git repository" >&2
  exit 1
fi

main_path_file=$(mktemp)
cleanup() {
  rm -f "$main_path_file"
}
trap cleanup EXIT

if [[ -n "$main_branch" ]]; then
  WORKTREE_MAIN_PATH_FILE="$main_path_file" worktree-merge --main "$main_branch"
  WORKTREE_MAIN_PATH_FILE="$main_path_file" worktree-delete
else
  WORKTREE_MAIN_PATH_FILE="$main_path_file" worktree-merge
  WORKTREE_MAIN_PATH_FILE="$main_path_file" worktree-delete
fi

if [[ -s "$main_path_file" ]]; then
  main_path=$(cat "$main_path_file")
  cd "$main_path"
fi
