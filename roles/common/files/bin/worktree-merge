#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<'EOF'
Usage: worktree-merge [--main <branch>]

Merges the current worktree branch into the main branch without deleting the worktree.
EOF
}

if ! command -v git >/dev/null 2>&1; then
  echo "Error: git is required" >&2
  exit 1
fi

main_branch=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --main)
      main_branch="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      echo "Error: unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      echo "Error: unexpected argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if ! repo_root=$(git rev-parse --show-toplevel 2>/dev/null); then
  echo "Error: not inside a git repository" >&2
  exit 1
fi

current_branch=$(git -C "$repo_root" branch --show-current)
if [[ -z "$current_branch" ]]; then
  echo "Error: detached HEAD; checkout a branch first" >&2
  exit 1
fi

current_path=$(git -C "$repo_root" rev-parse --show-toplevel)

if [[ -z "$main_branch" ]]; then
  origin_head=$(git -C "$repo_root" symbolic-ref -q --short refs/remotes/origin/HEAD || true)
  if [[ -n "$origin_head" ]]; then
    main_branch="${origin_head#origin/}"
  elif git -C "$repo_root" show-ref --verify --quiet refs/heads/main; then
    main_branch="main"
  else
    main_branch="master"
  fi
fi

if [[ "$current_branch" == "$main_branch" ]]; then
  echo "Error: already on ${main_branch}; this command is for non-main worktrees" >&2
  exit 1
fi

if [[ -n "$(git -C "$current_path" status --porcelain)" ]]; then
  echo "Error: worktree has uncommitted changes; commit or stash first" >&2
  exit 1
fi

main_path=""
while IFS= read -r line; do
  if [[ "$line" == worktree\ * ]]; then
    main_path="${line#worktree }"
  elif [[ "$line" == branch\ refs/heads/* ]]; then
    branch_name="${line#branch refs/heads/}"
    if [[ "$branch_name" == "$main_branch" ]]; then
      break
    fi
    main_path=""
  fi
done < <(git -C "$repo_root" worktree list --porcelain)

if [[ -z "$main_path" ]]; then
  echo "Error: could not find main worktree for branch ${main_branch}" >&2
  exit 1
fi

if [[ -n "$(git -C "$main_path" status --porcelain)" ]]; then
  echo "Error: main worktree has uncommitted changes; clean it first" >&2
  exit 1
fi

git -C "$main_path" checkout "$main_branch"
git -C "$main_path" merge "$current_branch"

if [[ -n "${WORKTREE_MAIN_PATH_FILE:-}" ]]; then
  printf '%s\n' "$main_path" > "$WORKTREE_MAIN_PATH_FILE"
fi

cd "$main_path"

echo "==> Merged ${current_branch} into ${main_branch}:"
echo "    Branch: ${current_branch}"
echo "    Main: ${main_path}"
