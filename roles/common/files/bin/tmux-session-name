#!/usr/bin/env bash
# Sets the tmux session name based on context:
#   - SSH with nested tmux: use pane_title (set by remote tmux)
#   - Git repo: "(branch) dirname"
#   - Non-git: "dirname"

[ -z "$TMUX" ] && exit 0

pane_id="${1:-$(tmux display-message -p '#{pane_id}')}"
[ -z "$pane_id" ] && exit 0

pane_tty=$(tmux display-message -p -t "$pane_id" '#{pane_tty}' 2>/dev/null) || exit 0
pane_current_path=$(tmux display-message -p -t "$pane_id" '#{pane_current_path}' 2>/dev/null)
[ -z "$pane_current_path" ] && exit 0

if ps -o args= -t "$pane_tty" 2>/dev/null | grep -qE '(^ssh |gh codespace ssh)'; then
  pane_title=$(tmux display-message -p -t "$pane_id" '#{pane_title}')
  if [ -n "$pane_title" ] && [ "$pane_title" != "$HOSTNAME" ] && [ "$pane_title" != "$USER@$HOSTNAME" ]; then
    name="$pane_title"
  else
    name="ssh"
  fi
else
  dir_basename=$(basename "$pane_current_path")
  branch=$(cd "$pane_current_path" 2>/dev/null && git branch --show-current 2>/dev/null)
  if [ -n "$branch" ]; then
    name="($branch) $dir_basename"
  else
    name="$dir_basename"
  fi
fi

session_id=$(tmux display-message -p -t "$pane_id" '#{session_id}' 2>/dev/null) || exit 0
[ -z "$session_id" ] && exit 0

tmux rename-session -t "$session_id" "$name" 2>/dev/null || true
