#!/usr/bin/env bash
# Sets the tmux session name based on context:
#   - SSH with nested tmux: use pane_title (set by remote tmux)
#   - Git repo: "(branch) dirname"
#   - Non-git: "dirname"

[ -z "$TMUX" ] && exit 0

pane_id="${1:-$(tmux display-message -p '#{pane_id}')}"

# Get all pane info in one atomic call to minimize race window
# Format: tty<TAB>path<TAB>title<TAB>session_id
pane_info=$(tmux display-message -p -t "$pane_id" '#{pane_tty}	#{pane_current_path}	#{pane_title}	#{session_id}' 2>/dev/null) || exit 0
[ -z "$pane_info" ] && exit 0

IFS=$'\t' read -r pane_tty pane_current_path pane_title session_id <<< "$pane_info"
[ -z "$session_id" ] && exit 0

pane_procs=$(ps -o args= -t "$pane_tty" 2>/dev/null)
if grep -qE '(^ssh |gh codespace ssh)' <<< "$pane_procs"; then
  if [ -n "$pane_title" ] && [ "$pane_title" != "$HOSTNAME" ] && [ "$pane_title" != "$USER@$HOSTNAME" ]; then
    name="$pane_title"
  else
    name="ssh"
  fi
else
  dir_basename=$(basename "$pane_current_path")
  branch=$(cd "$pane_current_path" 2>/dev/null && git branch --show-current 2>/dev/null)
  if [ -n "$branch" ]; then
    name="($branch) $dir_basename"
  else
    name="$dir_basename"
  fi
fi

# If already named correctly (base name or numbered variant), don't rename
current_name=$(tmux display-message -t "$session_id" -p '#{session_name}' 2>/dev/null) || exit 0
if [ "$current_name" = "$name" ] || [[ "$current_name" =~ ^"$name"\ [0-9]+$ ]]; then
  exit 0
fi

# Find an available name: try base name first, then " 2", " 3", etc.
if ! tmux has-session -t "=$name" 2>/dev/null; then
  tmux rename-session -t "$session_id" "$name" 2>/dev/null || true
else
  i=2
  while tmux has-session -t "=$name $i" 2>/dev/null; do
    ((i++))
  done
  tmux rename-session -t "$session_id" "$name $i" 2>/dev/null || true
fi
