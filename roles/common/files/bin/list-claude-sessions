#!/usr/bin/env bash
set -euo pipefail

# List recent Claude Code sessions with metadata
# Usage: list-claude-sessions [--days N] [--limit N] [--json] [--project PROJECT]

DAYS=7
LIMIT=10
JSON_OUTPUT=false
PROJECT=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --days)
      DAYS="$2"
      shift 2
      ;;
    --limit)
      LIMIT="$2"
      shift 2
      ;;
    --json)
      JSON_OUTPUT=true
      shift
      ;;
    --project)
      PROJECT="$2"
      shift 2
      ;;
    *)
      echo "Usage: list-claude-sessions [--days N] [--limit N] [--json] [--project PROJECT]" >&2
      exit 1
      ;;
  esac
done

CLAUDE_PROJECTS_DIR="${HOME}/.claude/projects"

if [[ ! -d "$CLAUDE_PROJECTS_DIR" ]]; then
  echo "No Claude projects directory found at $CLAUDE_PROJECTS_DIR" >&2
  exit 0
fi

# Build search path
if [[ -n "$PROJECT" ]]; then
  SEARCH_PATH="$CLAUDE_PROJECTS_DIR/$PROJECT"
else
  SEARCH_PATH="$CLAUDE_PROJECTS_DIR"
fi

# Find session files modified in the last N days, sorted by modification time (newest first)
SESSION_FILES=$(find "$SEARCH_PATH" -name "*.jsonl" -type f -mtime -"$DAYS" -print0 2>/dev/null | xargs -0 ls -t 2>/dev/null | head -n "$LIMIT")

if [[ -z "$SESSION_FILES" ]]; then
  echo "No Claude sessions found in the last $DAYS days" >&2
  exit 0
fi

# Function to get last non-meta user message from a session
get_last_user_message() {
  local file="$1"
  # Get the last non-meta user message (skip isMeta:true entries and command messages)
  # Extract text content only (not tool_result arrays)
  grep '"type":"user"' "$file" 2>/dev/null | \
    grep -v '"isMeta":true' | \
    grep -v '<command-name>' | \
    grep -v '<local-command' | \
    grep -v 'tool_use_id' | \
    tail -1 | \
    jq -r '.message.content | if type == "string" then . elif type == "array" then map(select(.type == "text") | .text) | join(" ") else empty end' 2>/dev/null | \
    head -c 150 | \
    tr '\n' ' ' || echo ""
}

if $JSON_OUTPUT; then
  echo "["
  first=true
  index=1
  echo "$SESSION_FILES" | while read -r file; do
    [[ -z "$file" ]] && continue
    # Extract metadata from first user message (skip file-history-snapshot lines)
    meta=$(grep -m1 '"type":"user"' "$file" 2>/dev/null | jq -c '{
      sessionId: .sessionId,
      cwd: .cwd,
      gitBranch: .gitBranch,
      timestamp: .timestamp,
      version: .version
    }' 2>/dev/null || echo '{}')

    if [[ -n "$meta" && "$meta" != "{}" && "$meta" != "null" ]]; then
      # Get last user message for preview (more useful for resuming)
      last_msg=$(get_last_user_message "$file")

      $first || echo ","
      first=false
      jq -c --arg file "$file" --arg preview "$last_msg" --argjson index "$index" \
        '. + {file: $file, preview: $preview, index: $index}' <<< "$meta"
      ((index++))
    fi
  done
  echo "]"
else
  printf "%-3s %-20s %-40s %s\n" "#" "TIMESTAMP" "PROJECT" "LAST MESSAGE"
  printf "%s\n" "$(printf '=%.0s' {1..120})"

  index=1
  echo "$SESSION_FILES" | while read -r file; do
    [[ -z "$file" ]] && continue
    # Extract metadata from first user message
    meta=$(grep -m1 '"type":"user"' "$file" 2>/dev/null | jq -r '"\(.timestamp // "unknown")\t\(.cwd // "unknown")"' 2>/dev/null || echo "unknown	unknown")
    timestamp=$(echo "$meta" | cut -f1)
    cwd=$(echo "$meta" | cut -f2)

    # Get project name from cwd
    project=$(basename "$cwd" 2>/dev/null || echo "unknown")

    # Get last user message for preview
    last_msg=$(get_last_user_message "$file")
    # Truncate for display
    last_msg="${last_msg:0:50}"
    [[ ${#last_msg} -eq 50 ]] && last_msg="${last_msg}..."

    printf "%-3s %-20s %-40s %s\n" "$index" "${timestamp:0:19}" "$project" "$last_msg"
    ((index++))
  done

  echo ""
  echo "Use 'list-claude-sessions --json' for full details including file paths."
fi
