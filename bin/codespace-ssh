#!/usr/bin/env ruby
# frozen_string_literal: true

require 'json'
require 'yaml'
require 'open3'

def command_exists?(cmd)
  system("command -v #{cmd} >/dev/null 2>&1")
end

def run_command(cmd, error_message: nil)
  stdout, stderr, status = Open3.capture3(cmd)
  unless status.success?
    puts "Error: #{error_message || "Command failed: #{cmd}"}"
    puts stderr unless stderr.empty?
    exit 1
  end
  stdout
end

def ensure_gh_installed
  return if command_exists?('gh')

  puts "Error: gh CLI is required but not installed"
  puts "Install it with: brew install gh"
  exit 1
end

def check_work_machine
  config_path = File.expand_path('~/.config/new-machine-bootstrap.yml')

  unless File.exist?(config_path)
    puts "Error: Configuration file not found at #{config_path}"
    puts "This script requires machine configuration to be set up first."
    exit 1
  end

  config = YAML.load_file(config_path)

  unless config['use'] == 'work'
    puts "Error: This script only works on work machines for security reasons."
    puts "Current machine type: #{config['use']}"
    exit 1
  end
end

def main
  ensure_gh_installed
  check_work_machine

  # Check if codespace name was provided as argument
  codespace_name = ARGV[0]

  if codespace_name
    puts "==> Connecting to Codespace: #{codespace_name}"
  else
    puts "==> Finding available Codespaces..."

    codespaces_json = run_command(
      'gh codespace list --json name,repository,state',
      error_message: 'Failed to list Codespaces'
    )

    all_codespaces = JSON.parse(codespaces_json)

    all_codespaces.each do |cs|
      case cs['state']
      when 'Available'
        puts "Found Codespace #{cs['name']} in state '#{cs['state']}'"
      when 'Queued', 'Starting'
        puts "Found Codespace #{cs['name']} but can't SSH to it because it is in state '#{cs['state']}' (still starting up)"
      when 'Shutdown'
        puts "Found Codespace #{cs['name']} but can't SSH to it because it is in state '#{cs['state']}' (use 'gh codespace ssh -c #{cs['name']}' to restart)"
      else
        puts "Found Codespace #{cs['name']} but can't SSH to it because it is in state '#{cs['state']}'"
      end
    end

    available = all_codespaces.select { |cs| cs['state'] == 'Available' }

    if available.empty?
      puts "\nError: No Codespaces in 'Available' state"
      puts "Wait for starting Codespaces to finish, or create a new one: gh codespace create"
      exit 1
    end

    puts ""
    codespaces = available

    codespace_name = if codespaces.size == 1
      puts "==> Found Codespace: #{codespaces[0]['name']}"
      codespaces[0]['name']
    else
      unless command_exists?('fzf')
        puts "Error: Multiple Codespaces found, but fzf is not installed"
        puts "Install fzf: brew install fzf"
        exit 1
      end

      puts "==> Multiple Codespaces found, please select one:"
      names = codespaces.map { |cs| cs['name'] }.join("\n")
      stdout, stderr, status = Open3.capture3('fzf --prompt="Select Codespace: "', stdin_data: names)

      unless status.success?
        puts "Error: No Codespace selected"
        exit 1
      end

      stdout.strip
    end
  end

  puts ""
  puts "==> Connecting to Codespace: #{codespace_name}"
  puts ""

  exec("gh codespace ssh -c #{codespace_name}")
end

main
