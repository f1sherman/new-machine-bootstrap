#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'json'
require 'open3'
require_relative '../lib/codespace_selector'
require_relative '../lib/dev_env_syncer'

def prompt_for_new_permissions(codespace_name, repo_full_name, remote_workspace_dir)
  new_permissions = DevEnvSyncer.get_new_permissions_from_codespace(
    Dir.pwd, codespace_name, remote_workspace_dir
  )

  return if new_permissions.empty?

  puts "\n==> Found #{new_permissions.length} new permission(s) in Codespace"

  local_settings_path = File.join(Dir.pwd, '.claude', 'settings.local.json')
  permissions_to_add = []

  new_permissions.each do |permission|
    print "    Add '#{permission}'? [y/N] "
    $stdout.flush
    response = $stdin.gets&.strip&.downcase
    permissions_to_add << permission if response == 'y'
  end

  return if permissions_to_add.empty?

  # Load or initialize local settings
  local_settings = if File.exist?(local_settings_path)
                     JSON.parse(File.read(local_settings_path))
                   else
                     { 'permissions' => { 'allow' => [], 'deny' => [] } }
                   end

  local_settings['permissions'] ||= {}
  local_settings['permissions']['allow'] ||= []
  local_settings['permissions']['allow'].concat(permissions_to_add)

  # Ensure directory exists
  FileUtils.mkdir_p(File.dirname(local_settings_path))

  File.write(local_settings_path, JSON.pretty_generate(local_settings) + "\n")
  puts "==> Added #{permissions_to_add.length} permission(s) to local settings"
rescue StandardError => e
  $stderr.puts "Warning: Could not sync permissions: #{e.message}"
end

def sync_coding_agent_back(codespace_name)
  stdout, stderr, status = Open3.capture3(
    "gh codespace list --json name,repository --jq '.[] | select(.name==\"#{codespace_name}\")'"
  )

  unless status.success?
    $stderr.puts "Warning: Could not query Codespace info for sync: #{stderr}"
    return
  end

  begin
    codespace_info = JSON.parse(stdout)
    repo_full_name = codespace_info['repository']
    return unless repo_full_name

    local_remote = `git remote get-url origin 2>/dev/null`.strip
    return if local_remote.empty?

    local_repo = normalize_github_repo(local_remote)
    return unless local_repo&.downcase == repo_full_name.downcase

    repo_name = repo_full_name.split('/').last
    remote_workspace_dir = "/workspaces/#{repo_name}"

    DevEnvSyncer.sync_from_codespace(Dir.pwd, codespace_name, remote_workspace_dir)
    prompt_for_new_permissions(codespace_name, repo_full_name, remote_workspace_dir)
  rescue JSON::ParserError, DevEnvSyncer::SyncError => e
    $stderr.puts "Warning: Could not sync .coding-agent: #{e.message}"
  end
end

def normalize_github_repo(url)
  if url =~ %r{git@github\.com:(.+?)(?:\.git)?$}
    return Regexp.last_match(1)
  end

  if url =~ %r{https://github\.com/(.+?)(?:\.git)?$}
    return Regexp.last_match(1)
  end

  nil
end

def main
  codespace_name = begin
    CodespaceSelector.select_codespace(codespace_name: ARGV[0])
  rescue CodespaceSelector::SelectionError => e
    puts "Error: #{e.message}"
    exit 1
  end

  puts "==> Connecting to Codespace: #{codespace_name}"
  puts ""

  # Save last codespace for quick reconnect via `csr` (per-terminal)
  tty_suffix = `tty 2>/dev/null`.strip.gsub(%r{^/dev/}, '').gsub('/', '-')
  unless tty_suffix.empty?
    File.write(File.expand_path("~/.last-codespace-#{tty_suffix}"), codespace_name)
  end

  system("gh codespace ssh -c #{codespace_name}")
  ssh_exit_code = $?.exitstatus

  puts "\n==> Disconnected from codespace: #{codespace_name}"

  sync_coding_agent_back(codespace_name)

  print "Stop this codespace? [y/N] "
  $stdout.flush
  response = $stdin.gets&.strip&.downcase
  if response == 'y'
    puts "==> Stopping codespace..."
    system("gh codespace stop -c #{codespace_name}")
  else
    puts "To reconnect run: codespace-ssh #{codespace_name}"
  end

  exit ssh_exit_code
end

main
