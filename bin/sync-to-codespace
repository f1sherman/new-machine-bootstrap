#!/usr/bin/env ruby
# frozen_string_literal: true

SCRIPT_DIR = File.expand_path('..', __dir__)
require_relative File.join(SCRIPT_DIR, 'lib', 'codespace_selector')

def main
  codespace_name = begin
    CodespaceSelector.select_codespace(codespace_name: ARGV[0], filter_available: true)
  rescue CodespaceSelector::SelectionError => e
    puts "Error: #{e.message}"
    exit 1
  end

  puts "==> Syncing repository to Codespace: #{codespace_name}"
  puts "    Excluding: .git/, .coding-agent/, .claude/, *.backup files, macOS metadata"
  puts ""

  Dir.chdir(SCRIPT_DIR)

  tar_cmd = "tar czf - --no-xattrs --exclude='.git' --exclude='.coding-agent' --exclude='.claude' --exclude='*.backup' --exclude='.DS_Store' --exclude='._*' --exclude='.codespace-defaults.yml' ."
  ssh_cmd = "gh codespace ssh -c #{codespace_name} -- 'mkdir -p ~/new-machine-bootstrap && cd ~/new-machine-bootstrap && tar xzf -'"
  sync_cmd = "#{tar_cmd} | #{ssh_cmd}"

  system(sync_cmd)

  unless $?.success?
    puts "Error: Failed to sync repository"
    exit 1
  end

  puts ""
  puts "==> Sync complete!"
  puts ""
  puts "==> Running provisioning in Codespace..."
  puts ""

  system("gh codespace ssh -c #{codespace_name} -t -- 'cd ~/new-machine-bootstrap && bash ./bin/provision'")

  puts ""
  puts "==> Provisioning complete!"
end

main
