#!/usr/bin/env ruby
# frozen_string_literal: true

# Ensure output is not buffered
$stdout.sync = true
$stderr.sync = true

require 'optparse'
require 'json'
require 'open3'

SCRIPT_DIR = File.expand_path('..', __dir__)
require_relative File.join(SCRIPT_DIR, 'lib', 'codespace_selector')
require_relative File.join(SCRIPT_DIR, 'lib', 'claude_session_syncer')

def sync_to_codespace(codespace_name)
  puts "==> Syncing repository to Codespace: #{codespace_name}"
  puts "    Excluding: .git/, .coding-agent/, .claude/, *.backup files, macOS metadata"
  puts ""

  Dir.chdir(SCRIPT_DIR)

  tar_cmd = "tar czf - --no-xattrs --exclude='.git' --exclude='.coding-agent' --exclude='.claude' --exclude='*.backup' --exclude='.DS_Store' --exclude='._*' --exclude='.codespace-defaults.yml' ."
  ssh_cmd = "gh codespace ssh -c #{codespace_name} -- 'mkdir -p ~/new-machine-bootstrap && cd ~/new-machine-bootstrap && tar xzf -'"
  sync_cmd = "#{tar_cmd} | #{ssh_cmd}"

  system(sync_cmd)

  unless $?.success?
    puts "Error: Failed to sync repository to #{codespace_name}"
    return false
  end

  puts ""
  puts "==> Sync complete!"
  puts ""
  puts "==> Running provisioning in Codespace..."
  puts ""

  # Run provisioning with unbuffered output
  # Pass local GH_TOKEN since Codespace secrets aren't available via SSH
  # script -q -e allocates a PTY for real-time output, -c runs the command, output goes to /dev/null (no typescript file)
  gh_token = `gh auth token 2>/dev/null`.strip
  token_export = gh_token.empty? ? '' : "export GH_TOKEN='#{gh_token}' && "
  provision_cmd = %Q{gh codespace ssh -c #{codespace_name} -- 'script -q -e -c "bash -l -c \\"#{token_export}cd ~/new-machine-bootstrap && ./bin/provision\\"" /dev/null'}
  puts "Running: gh codespace ssh -c #{codespace_name} -- 'script ... ./bin/provision'"
  system(provision_cmd)

  unless $?.success?
    puts ""
    puts "=" * 60
    puts "ERROR: Provisioning failed for #{codespace_name}!"
    puts "=" * 60
    puts ""
    puts "To investigate, check the log file:"
    puts "  gh codespace ssh -c #{codespace_name} -- 'cat /tmp/provision-latest.log'"
    puts ""
    puts "Or SSH in manually:"
    puts "  gh codespace ssh -c #{codespace_name}"
    puts ""
    return false
  end

  puts ""
  puts "==> Provisioning complete for #{codespace_name}!"
  true
end

def sync_sessions_to_codespace(codespace_name)
  # Get Codespace repository info
  stdout, _stderr, status = Open3.capture3(
    "gh codespace list --json name,repository --jq '.[] | select(.name==\"#{codespace_name}\")'"
  )

  return false unless status.success?

  begin
    codespace_info = JSON.parse(stdout)
    repo_full_name = codespace_info['repository']
    return false unless repo_full_name

    repo_name = repo_full_name.split('/').last

    puts "\n==> Syncing Claude sessions to #{codespace_name}..."
    ClaudeSessionSyncer.sync_sessions_to_codespace(repo_name, codespace_name)
    true
  rescue JSON::ParserError, StandardError => e
    puts "    Warning: Could not sync sessions: #{e.message}"
    false
  end
end

def main
  options = { sessions: true }

  parser = OptionParser.new do |opts|
    opts.banner = "Usage: bin/sync-to-codespace [OPTIONS] [CODESPACE_NAME]"
    opts.separator ""
    opts.separator "Syncs repository to Codespace and runs provisioning."
    opts.separator "If no codespace name provided, syncs to all available Codespaces."
    opts.separator ""
    opts.separator "Options:"

    opts.on("--no-sessions", "Skip syncing Claude sessions") do
      options[:sessions] = false
    end

    opts.on("-h", "--help", "Show this help message") do
      puts opts
      exit
    end
  end

  begin
    parser.parse!
  rescue OptionParser::InvalidOption => e
    puts "Error: #{e.message}"
    puts ""
    puts parser
    exit 1
  end

  if ARGV[0]
    # Specific codespace provided - sync to just that one
    sync_to_codespace(ARGV[0]) || exit(1)
    sync_sessions_to_codespace(ARGV[0]) if options[:sessions]
  else
    # No codespace specified - sync to all available
    codespaces = CodespaceSelector.all_available_codespaces

    if codespaces.empty?
      puts "Error: No available Codespaces found. Create one with: codespace-create"
      exit 1
    end

    puts "==> Found #{codespaces.size} available Codespace(s): #{codespaces.join(', ')}"
    puts ""

    failed = []
    codespaces.each_with_index do |codespace_name, index|
      puts "=" * 60
      puts "==> [#{index + 1}/#{codespaces.size}] Processing: #{codespace_name}"
      puts "=" * 60
      puts ""

      if sync_to_codespace(codespace_name)
        sync_sessions_to_codespace(codespace_name) if options[:sessions]
      else
        failed << codespace_name
      end
      puts ""
    end

    if failed.any?
      puts "Error: Failed to sync to: #{failed.join(', ')}"
      exit 1
    end

    puts "=" * 60
    puts "==> All #{codespaces.size} Codespace(s) synced successfully!"
    puts "=" * 60
  end
end

main
