#!/usr/bin/env ruby
# frozen_string_literal: true

# Ensure output is not buffered
$stdout.sync = true
$stderr.sync = true

SCRIPT_DIR = File.expand_path('..', __dir__)
require_relative File.join(SCRIPT_DIR, 'lib', 'codespace_selector')

def sync_to_codespace(codespace_name)
  puts "==> Syncing repository to Codespace: #{codespace_name}"
  puts "    Excluding: .git/, .coding-agent/, .claude/, *.backup files, macOS metadata"
  puts ""

  Dir.chdir(SCRIPT_DIR)

  tar_cmd = "tar czf - --no-xattrs --exclude='.git' --exclude='.coding-agent' --exclude='.claude' --exclude='*.backup' --exclude='.DS_Store' --exclude='._*' --exclude='.codespace-defaults.yml' ."
  ssh_cmd = "gh codespace ssh -c #{codespace_name} -- 'mkdir -p ~/new-machine-bootstrap && cd ~/new-machine-bootstrap && tar xzf -'"
  sync_cmd = "#{tar_cmd} | #{ssh_cmd}"

  system(sync_cmd)

  unless $?.success?
    puts "Error: Failed to sync repository to #{codespace_name}"
    return false
  end

  puts ""
  puts "==> Sync complete!"
  puts ""
  puts "==> Running provisioning in Codespace..."
  puts ""

  # Run provisioning with unbuffered output
  # Use bash -l (login shell) to source profile and get GH_TOKEN
  # script -q -e allocates a PTY for real-time output, -c runs the command, output goes to /dev/null (no typescript file)
  provision_cmd = %Q{gh codespace ssh -c #{codespace_name} -- 'script -q -e -c "bash -l -c \\"cd ~/new-machine-bootstrap && ./bin/provision\\"" /dev/null'}
  puts "Running: #{provision_cmd}"
  system(provision_cmd)

  unless $?.success?
    puts ""
    puts "=" * 60
    puts "ERROR: Provisioning failed for #{codespace_name}!"
    puts "=" * 60
    puts ""
    puts "To investigate, check the log file:"
    puts "  gh codespace ssh -c #{codespace_name} -- 'cat /tmp/provision-latest.log'"
    puts ""
    puts "Or SSH in manually:"
    puts "  gh codespace ssh -c #{codespace_name}"
    puts ""
    return false
  end

  puts ""
  puts "==> Provisioning complete for #{codespace_name}!"
  true
end

def main
  if ARGV[0]
    # Specific codespace provided - sync to just that one
    sync_to_codespace(ARGV[0]) || exit(1)
  else
    # No codespace specified - sync to all available
    codespaces = CodespaceSelector.all_available_codespaces

    if codespaces.empty?
      puts "Error: No available Codespaces found. Create one with: codespace-create"
      exit 1
    end

    puts "==> Found #{codespaces.size} available Codespace(s): #{codespaces.join(', ')}"
    puts ""

    failed = []
    codespaces.each_with_index do |codespace_name, index|
      puts "=" * 60
      puts "==> [#{index + 1}/#{codespaces.size}] Processing: #{codespace_name}"
      puts "=" * 60
      puts ""

      failed << codespace_name unless sync_to_codespace(codespace_name)
      puts ""
    end

    if failed.any?
      puts "Error: Failed to sync to: #{failed.join(', ')}"
      exit 1
    end

    puts "=" * 60
    puts "==> All #{codespaces.size} Codespace(s) synced successfully!"
    puts "=" * 60
  end
end

main
