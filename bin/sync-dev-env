#!/usr/bin/env ruby
# frozen_string_literal: true

require 'json'
require 'optparse'
require 'open3'

SCRIPT_DIR = File.expand_path('..', __dir__)
require_relative File.join(SCRIPT_DIR, 'lib', 'codespace_selector')
require_relative File.join(SCRIPT_DIR, 'lib', 'dev_env_syncer')

def main
  codespace_name = nil

  parser = OptionParser.new do |opts|
    opts.banner = "Usage: bin/sync-dev-env [CODESPACE_NAME]"
    opts.separator ""
    opts.separator "Sync .coding-agent directory and other dev env files from local to Codespace"
    opts.separator ""
    opts.separator "Arguments:"
    opts.separator "  CODESPACE_NAME    Optional. If not provided, will prompt for selection"
    opts.separator ""
    opts.separator "Examples:"
    opts.separator "  bin/sync-dev-env"
    opts.separator "  bin/sync-dev-env my-codespace-name"

    opts.on("-h", "--help", "Show this help message") do
      puts opts
      exit
    end
  end

  begin
    parser.parse!
    codespace_name = ARGV[0]
  rescue OptionParser::InvalidOption => e
    puts "Error: #{e.message}"
    puts ""
    puts parser
    exit 1
  end

  local_path = File.join(Dir.pwd, '.coding-agent')
  unless Dir.exist?(local_path)
    puts "Error: No .coding-agent directory in current directory"
    exit 1
  end

  codespace_name = begin
    CodespaceSelector.select_codespace(codespace_name: codespace_name, filter_available: true)
  rescue CodespaceSelector::SelectionError => e
    puts "Error: #{e.message}"
    exit 1
  end

  puts "==> Using Codespace: #{codespace_name}"

  stdout, stderr, status = Open3.capture3("gh codespace list --json name,repository --jq '.[] | select(.name==\"#{codespace_name}\")'")

  unless status.success?
    $stderr.puts "Error: Could not query Codespace information"
    $stderr.puts stderr unless stderr.empty?
    exit 1
  end

  begin
    codespace_info = JSON.parse(stdout)
    repo_full_name = codespace_info['repository']

    unless repo_full_name
      $stderr.puts "Error: Could not determine Codespace repository"
      exit 1
    end

    repo_name = repo_full_name.split('/').last
    remote_path = "/workspaces/#{repo_name}/.coding-agent"

    puts "    Repository: #{repo_full_name}"
    puts "    Workspace: /workspaces/#{repo_name}"

    DevEnvSyncer.sync_to_codespace(Dir.pwd, codespace_name, remote_path, codespace_repository: repo_full_name)
  rescue JSON::ParserError => e
    $stderr.puts "Error: Could not parse Codespace information"
    exit 1
  rescue DevEnvSyncer::SyncError => e
    $stderr.puts "\nError: Sync failed"
    $stderr.puts e.message
    exit 1
  end

  puts "\n==> Done!"
end

main
